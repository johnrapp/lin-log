---
title: "Predicting the burned area of a forest fire in northeastern Portugal"
author: "Axel SjÃ¶berg & John Rapp Farnes"
date: "14 maj 2019"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
classoption: a4paper
---

```{r setup_knitr, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  collapse = TRUE,
  comment = "#>"
)

options(tinytex.verbose = TRUE)
```

```{r setup_pdf, eval = FALSE}
# Install from CRAN
install.packages('rmarkdown')
# Render PDF
install.packages("tinytex")
tinytex::install_tinytex()  # install TinyTeX
```

```{r, code = readLines("lib.R")}

```

```{r, code = readLines("script.R")}


```


```{r}
titanic <- read.csv("titanic.csv")
titanic <- subset(titanic, select = -c(Name))
colnames(titanic) <- c(
  "survived",
  "pclass",
  "sex",
  "age",
  "siblings.spouses",
  "parents.children",
  "fare"
)

titanic
```



<!-- Abstract? -->

# Introduction

<!-- Syfte -->

# Analysis

```{r}
ggpairs(titanic)
```

```{r}
hist(titanic$fare)

high.fare.passengers <- which(titanic$fare > 200)

low.fare.passengers <- which(titanic$fare <= 0)

titanic[high.fare.passengers,]
titanic[low.fare.passengers,]

length(high.fare.passengers)
length(low.fare.passengers)
```

```{r}
hist(titanic$parents.children)
which(titanic$parents.children > 2)
```


```{r}
# titanic <- titanic[-high.fare.passengers,]
#   
# hist(log(titanic$Fare))

titanic$log.fare <- log(titanic$fare + 1)
hist(titanic$log.fare)
```

```{r}
hist(log(titanic[which(titanic$pclass == 1),]$fare + 1))
hist(log(titanic[which(titanic$pclass == 2),]$fare + 1))
hist(log(titanic[which(titanic$pclass == 3),]$fare + 1))
```


```{r}
model.log.fare <- plot.binary.model(survived ~ log.fare, titanic, titanic$survived, titanic$log.fare, "log.fare", c(0, 500), 1)
plot.binary.model(survived ~ siblings.spouses, titanic, titanic$survived, titanic$siblings.spouses, "siblings.spouses", c(0, 10), 40)
plot.binary.model(survived ~ parents.children, titanic, titanic$survived, titanic$parents.children, "parents.children", c(0, 10), 40)
plot.binary.model(survived ~ age, titanic, titanic$survived, titanic$age, "age", c(0, 80), 40)

summary(model.log.fare)
dataset <- titanic
pR2(model.log.fare)["r2CU"]
```



## Survived vs age


Age vs survived
```{r}
model.age <- plot.binary.model(survived ~ age, titanic, titanic$survived, titanic$age, "age", c(0, 80), 40)

summary(model.age)
dataset <- titanic
pR2(model.age)["r2CU"]
```

Divide into age groups?
- Children saved first
- Mothers in certain age
- Seniors not prioritized

```{r}
titanic$age.group.even <- cut(titanic$age, seq(0, 80, 10))

cross.age.survive <- table(titanic$age.group.even, titanic$survived)
freq.table.age.survive <- prop.table(cross.age.survive, 1)

cbind(freq.table.age.survive, count = table(titanic$age.group.even))

plot(freq.table.age.survive[,2])
axis(1, at=1:nrow(freq.table.age.survive), rownames(freq.table.age.survive))
```

Good survival rate small children, then lower for young adults, higher for adults, low for seniors
Little data on 50+, merge into one

```{r}
```


```{r}
titanic$age.group <- cut(titanic$age, c(0, 15, 30, 55, 100), labels = c("Child",  "Young adult", "Adult", "Senior"))
titanic$age.group <- relevel(titanic$age.group, ref = "Adult")

cross.age.survive <- table(titanic$age.group, titanic$survived)
freq.table.age.survive <- prop.table(cross.age.survive, 1)

cbind(freq.table.age.survive, count = table(titanic$age.group))

plot(freq.table.age.survive[,2], xaxt = "n")
axis(1, at=1:nrow(freq.table.age.survive), rownames(freq.table.age.survive))
```

Quite spread out

```{r}
table(titanic$age.group, titanic$parents.children)
table(titanic$age.group, titanic$siblings.spouses)
```

Hard to distinquish children from parents and siblings from spouses

Next, fit model

```{r}
model.age.group <- glm(survived ~ age.group, data = titanic, family = "binomial")

(sum.age.group <- summary(model.age.group))
```

Significant

Look at beta, OR and prob with confidence interval

```{r}

cbind(beta = sum.age.group$coefficients[, "Estimate"], confint(model.age.group))
cbind(OR = exp(sum.age.group$coefficients[, "Estimate"]), exp(confint(model.age.group)))

x0 <- data.frame(age.group = rownames(freq.table.age.survive))
pred <- predict(model.age.group, x0, se.fit = TRUE, type = "response")

standard.error <- 1.96
ci.prob <- cbind("2.5 %" = pred$fit - standard.error * pred$se.fit, 
                "97.5 %" = pred$fit + standard.error * pred$se.fit)

cbind(x0, pred$fit * 100, ci.prob * 100)

```


Compare models, with fare


```{r}
models <- list(
  glm(survived ~ age, data = titanic, family = "binomial"),
  glm(survived ~ age.group, data = titanic, family = "binomial"),
  glm(survived ~ age.group.even, data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1), data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) + age, data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) + age.group, data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) + age.group.even, data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) * age.group, data = titanic, family = "binomial")
)
model.names <- c(
  "age",
  "group",
  "even",
  "fare",
  "fare + age",
  "fare + group",
  "fare + even",
  "fare * group"
)

compare.models <- calc.metrics.models(models, model.names)
compare.models
```

```{r, fig.width = 8}
plot.compare.models(compare.models, c(1050, 1250))
```

Remove the worst
```{r}
models <- list(
  glm(survived ~ log(fare + 1), data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) + age, data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) + age.group, data = titanic, family = "binomial"),
  glm(survived ~ log(fare + 1) * age.group, data = titanic, family = "binomial")
)
model.names <- c(
  "fare",
  "fare + age",
  "fare + group",
  "fare * group"
)

compare.models <- calc.metrics.models(models, model.names)
compare.models
```

```{r, fig.width = 8}
plot.compare.models(compare.models, c(1050, 1120))
```

## Sex



<!-- ```{r} -->
<!-- hist(dataset$area) -->
<!-- hist(dataset$rain) -->

<!-- hist(log(dataset$area)) -->
<!-- hist(log(dataset$area + 1)) -->
<!-- hist(log(dataset$rain)) -->
<!-- hist(log(dataset$rain + 1)) -->

<!-- hist(dataset$temp) -->
<!-- hist(dataset$RH) -->
<!-- hist(dataset$wind) -->

<!-- plot(dataset$X, dataset$Y) -->

<!-- #temp, RH, wind and rain -->
<!-- pairs(~ area + temp + RH + wind + rain, data = dataset) -->

<!-- pairs(~ log(area + 1) + temp + RH + wind + log(rain + 1), data = dataset) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- hist(dataset$FFMC) -->
<!-- hist((dataset$FFMC)^(1/3)) -->


<!-- # FFMC, DMC, DC, ISI -->
<!-- pairs(~ area + FFMC + DMC + DC + ISI, data = dataset) -->
<!-- pairs(~ log(area + 1) + FFMC + DMC + DC + ISI, data = dataset) -->

<!-- pairs(~ FFMC + DMC + DC + ISI + temp + RH + wind + log(rain + 1), data = dataset) -->

<!-- # pairs(~ log(area + 1) + FFMC.squared + DMC + DC + ISI, data = dataset) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- dataset <- cbind(dataset, log.area = log(dataset$area + 1), log.rain = log(dataset$rain + 1)) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- dataset.cut <- dataset[dataset$area > 0,] -->
<!-- dataset.cut -->

<!-- pairs(~ log(area) + temp + RH + wind, data = dataset.cut) -->


<!-- ``` -->



<!-- ```{r} -->
<!-- inverse.log <- function(x) exp(x) - 1 -->

<!-- model.wind <- plot.correlation.model(area ~ wind, "wind", c(0, 10)) -->
<!-- model.temp <- plot.correlation.model(area ~ temp, "temp", c(0, 35)) -->
<!-- model.RH <- plot.correlation.model(area ~ RH, "RH", c(15, 110)) -->

<!-- summary(model.wind) -->
<!-- summary(model.temp) -->
<!-- summary(model.RH) -->

<!-- calc.metrics.models(list(model.wind, model.temp, model.RH), c("wind", "temp", "RH")) -->

<!-- ``` -->
<!-- ```{r} -->
<!-- dataset -->
<!-- hist(dataset$area) -->
<!-- summary(dataset$area) -->
<!-- ``` -->

<!-- ```{r} -->

<!-- dataset <- cbind(dataset, big.fire = ifelse(dataset$area > 0, 1, 0)) -->

<!-- pairs(~ big.fire + temp + RH + wind, data = dataset) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- model.wind <- plot.binary.model(big.fire ~ wind, dataset$big.fire, dataset$wind, "wind", c(0, 10), 10) -->
<!-- model.temp <- plot.binary.model(big.fire ~ temp, dataset$big.fire, dataset$temp, "temp", c(0, 35), 10) -->
<!-- model.RH <- plot.binary.model(big.fire ~ RH, dataset$big.fire, dataset$RH, "RH", c(15, 110), 10) -->

<!-- summary(model.temp) -->
<!-- ``` -->


